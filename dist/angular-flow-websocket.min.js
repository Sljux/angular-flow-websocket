"use strict";angular.module("ngFlow.websocket",["ngWebSocket"]).factory("FlowWebsocket",["$http","$websocket","$q","$interval",function(a,b,c,d){function e(){return"search-"+C++}function f(b,c){return a({method:"POST",url:"https://ws.flowthings.io/session",headers:{"X-Auth-Account":b,"X-Auth-Token":c}})}function g(a){return(w(a.accountId)||w(a.token))&&s(E.errors.NO_CREDENTIALS),f(a.accountId,a.token).success(function(b){!b.head||b.head.ok!==!0&&"true"!==b.head.ok?s(r(b.body.errors)):(z=a,j(b.body.id),h(E.heartbeat.interval))}).error(s),F}function h(a){u=d(function(){t.send(E.heartbeat.message)},a)}function i(){v(u)&&(d.cancel(u),u=void 0)}function j(a){t=b("wss://ws.flowthings.io/session/"+a+"/ws"),t.onOpen(function(a){B.resolve(!0),console.log("opened",a)}),t.onClose(function(a){console.log("closed",a),i(),g(z)}),t.onError(function(a){console.log("error",a)}),t.onMessage(function(a){var b=JSON.parse(a.data);if(console.log(b),"message"===b.type){var c=b.value.flowId;v(A[c])&&A[c](l(b.value))}else if(v(b.head)){var d=b.head.msgId;v(D[d])&&(D[d].resolve(k(b)),delete D[d])}})}function k(a){var b=x(a.body),c=[];return y(b,function(a){c.push(l(a))}),c}function l(a){var b=x(a.elems);return m(b),b.creationDate=a.creationDate,b}function m(a){y(a,function(b,c){switch(a[c]=b.value,b.type){case"map":case"sortedMap":m(a[c]);break;case"list":case"set":case"sortedSet":y(a[c],function(a){m(a)})}})}function n(a,b){B.promise.then(function(){q("subscribe",a),angular.isFunction(b)&&(A[a]=b)})}function o(a){B.promise.then(function(){q("unsubscribe",a),delete A[a]})}function p(a,b,d){return B.promise.then(function(){var f=c.defer(),g=e();return D[g]=f,t.send(E.searchObject(a,g,b,d)),f.promise})}function q(a,b,c){B.promise.then(function(){var d=c||E.baseMsgId++;t.send({msgId:d,object:"drop",type:a,flowId:b})})}function r(a){return a.join("\n")}function s(a){throw new Error(a)}var t,u,v=angular.isDefined,w=angular.isUndefined,x=angular.copy,y=angular.forEach,z={},A={},B=c.defer(),C=1,D={},E={baseMsgId:1,heartbeat:{message:{type:"heartbeat"},interval:2e4},searchObject:function(a,b,c,d){var e={object:"drop",type:"findmany",flowId:a,msgId:b,options:{filter:c,order:"desc",hints:0}};return d&&(e.options.limit=d),e},errors:{NO_CREDENTIALS:"Provide account Id and token",NO_SESSION_ID:"No session ID"}},F={flow:{subscribe:n,unsubscribe:o,search:p}};return g}]);